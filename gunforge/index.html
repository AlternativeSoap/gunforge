<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gunforge: Wasteland Echoes</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <canvas id="game"></canvas>

    <!-- Start overlay to unlock audio and pointer lock -->
    <div id="overlay" class="overlay visible">
      <div class="animated-bg"></div>
      <div class="panel">
        <div class="title-container">
          <h1 class="game-title">
            <span class="title-word" style="--delay: 0s;">GUNFORGE</span>
          </h1>
          <h2 class="game-subtitle">Wasteland Echoes</h2>
        </div>
        
        <p class="tagline">A post-apocalyptic roguelike shooter</p>
        
        <div class="controls-section">
          <h3>üéÆ Controls</h3>
          <div class="controls-grid">
            <div class="control-item">
              <span class="key">WASD</span>
              <span class="desc">Move</span>
            </div>
            <div class="control-item">
              <span class="key">Mouse</span>
              <span class="desc">Aim & Shoot</span>
            </div>
            <div class="control-item">
              <span class="key">Shift</span>
              <span class="desc">Dash</span>
            </div>
            <div class="control-item">
              <span class="key">E</span>
              <span class="desc">Interact</span>
            </div>
            <div class="control-item">
              <span class="key">R</span>
              <span class="desc">Swap Weapon</span>
            </div>
            <div class="control-item">
              <span class="key">M</span>
              <span class="desc">Map</span>
            </div>
          </div>
        </div>
        
        <!-- Difficulty Selector -->
        <div class="difficulty-selector">
          <h3>‚öîÔ∏è Select Difficulty</h3>
          <div class="difficulty-buttons">
            <button class="diff-btn diff-easy" data-difficulty="easy">
              <div class="diff-icon">üòä</div>
              <strong>Easy</strong>
              <span>+50% HP, +30% Damage<br>-30% Enemy Stats</span>
            </button>
            <button class="diff-btn diff-medium selected" data-difficulty="medium">
              <div class="diff-icon">‚ö°</div>
              <strong>Medium</strong>
              <span>Balanced Experience<br>Standard Stats</span>
            </button>
            <button class="diff-btn diff-hard" data-difficulty="hard">
              <div class="diff-icon">üî•</div>
              <strong>Hard</strong>
              <span>-20% HP, -10% Damage<br>+40% Enemy Stats</span>
            </button>
            <button class="diff-btn diff-nightmare" data-difficulty="nightmare">
              <div class="diff-icon">üíÄ</div>
              <strong>Nightmare</strong>
              <span>-50% HP, -20% Damage<br>+100% Enemy Stats</span>
            </button>
          </div>
        </div>
        
        <div class="main-menu-buttons">
          <button id="startBtn" class="start-button" onclick="window.requestGameStart && window.requestGameStart()">
            <span class="btn-text">NEW GAME</span>
            <span class="btn-glow"></span>
          </button>
          
          <button id="loadGameBtn" class="load-game-button">
            <span class="btn-text">üíæ LOAD GAME</span>
            <span class="btn-glow"></span>
          </button>
        </div>
      </div>
    </div>
    <script>
      // Warn if running from file:// where ES modules won't load
      if (location.protocol === 'file:') {
        console.warn('This game must be opened via http(s) not file://. Start a local server.');
        setTimeout(()=>{
          const p = document.createElement('p');
          p.textContent = 'Warning: Open this via a local server (http://localhost), not by double-clicking the file.';
          p.style.color = '#ff5252';
          p.style.marginTop = '8px';
          document.querySelector('.panel')?.appendChild(p);
        }, 0);
      }
      // Store selected difficulty (default: medium)
      window.__GAME_DIFFICULTY__ = 'medium';
      
      // Difficulty button selection
      document.addEventListener('DOMContentLoaded', () => {
        const diffBtns = document.querySelectorAll('.diff-btn');
        diffBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            // Remove selected class from all buttons
            diffBtns.forEach(b => b.classList.remove('selected'));
            // Add selected class to clicked button
            btn.classList.add('selected');
            // Store difficulty
            window.__GAME_DIFFICULTY__ = btn.getAttribute('data-difficulty');
            console.log('Difficulty selected:', window.__GAME_DIFFICULTY__);
          });
        });
        
        // Save/Load System UI
        function formatTime(timestamp) {
          if (!timestamp) return '--';
          const date = new Date(timestamp);
          return date.toLocaleString();
        }
        
        function updateSaveSlots() {
          if (!window.saveManager) {
            console.log('SaveManager not loaded yet, will retry...');
            setTimeout(updateSaveSlots, 100);
            return;
          }
          
          const slotsInfo = window.saveManager.getAllSlotsInfo();
          slotsInfo.forEach((slotInfo, index) => {
            // Update all save slot displays (both in save menu and home screen if it exists)
            const slotSelectors = [
              `.save-menu-overlay .save-slot[data-slot="${slotInfo.slotNumber}"]`,
              `#overlay .save-slot[data-slot="${slotInfo.slotNumber}"]`
            ];
            
            slotSelectors.forEach(selector => {
              const slotEl = document.querySelector(selector);
              if (!slotEl) return;
              
              const emptyEl = slotEl.querySelector('.slot-empty');
              const dataEl = slotEl.querySelector('.slot-data');
              const loadBtn = slotEl.querySelector('.load-btn');
              const deleteBtn = slotEl.querySelector('.delete-btn');
              
              if (slotInfo.isEmpty) {
                emptyEl.style.display = 'block';
                dataEl.style.display = 'none';
                loadBtn.disabled = true;
                deleteBtn.disabled = true;
              } else {
                emptyEl.style.display = 'none';
                dataEl.style.display = 'block';
                dataEl.querySelector('.level-val').textContent = slotInfo.level;
                const coinsEl = dataEl.querySelector('.coins-val');
                if (coinsEl) coinsEl.textContent = slotInfo.coins || 0;
                dataEl.querySelector('.layer-val').textContent = slotInfo.layer;
                dataEl.querySelector('.diff-val').textContent = slotInfo.difficulty;
                dataEl.querySelector('.time-val').textContent = formatTime(slotInfo.timestamp);
                loadBtn.disabled = false;
                deleteBtn.disabled = false;
              }
            });
          });
        }
        
        // Update save menu mode based on game state
        function updateSaveMenuMode() {
          const isInGame = window.game && window.game.started && !window.game.dead;
          const saveMenu = document.getElementById('saveMenu');
          const title = saveMenu.querySelector('.save-menu-title');
          const saveBtns = saveMenu.querySelectorAll('.save-btn');
          
          if (isInGame) {
            // In-game: Show Save buttons
            title.textContent = 'üíæ Save Game';
            saveBtns.forEach(btn => {
              btn.style.display = 'block';
            });
          } else {
            // Home screen: Hide Save buttons
            title.textContent = 'üíæ Load Game';
            saveBtns.forEach(btn => {
              btn.style.display = 'none';
            });
          }
        }
        
        // Expose globally for use in main.js pause menu
        window.updateSaveSlots = updateSaveSlots;
        window.updateSaveMenuMode = updateSaveMenuMode;
        
        // Load/Save game from slot - use event delegation for dynamically updated buttons
        document.addEventListener('click', (e) => {
          // Check if click is on a load button
          const loadBtn = e.target.closest('.load-btn');
          if (!loadBtn || loadBtn.disabled) return;
          
          // Check if the button is inside the save menu
          const saveMenu = document.getElementById('saveMenu');
          if (!saveMenu.classList.contains('visible')) return;
          if (!saveMenu.contains(loadBtn)) return;
          
          const slotEl = loadBtn.closest('.save-slot');
          if (!slotEl) return;
          
          const slotNum = parseInt(slotEl.getAttribute('data-slot'));
          const isInGame = window.game && window.game.started && !window.game.dead;
          
          console.log('[Save Menu] Button clicked - Slot:', slotNum, 'InGame:', isInGame);
          
          if (isInGame) {
            // In-game: Save to this slot
            if (window.saveManager && window.game && window.game.player) {
              const saved = window.saveManager.saveToSlot(
                slotNum,
                window.game.player,
                window.game.coins,
                window.game.depth,
                window.GAME ? window.GAME.difficulty : 'medium',
                window.game.gameTime || 0
              );
              if (saved) {
                window.game.promptTimed(`üíæ Saved to Slot ${slotNum}!`, 1.5);
                console.log('[Save Menu] Successfully saved to slot:', slotNum);
                saveMenu.classList.remove('visible');
                updateSaveSlots();
              } else {
                console.error('[Save Menu] Failed to save to slot:', slotNum);
              }
            } else {
              console.error('[Save Menu] Missing required data for saving');
            }
          } else {
            // Home screen: Load from this slot
            console.log('[Save Menu] Loading from slot:', slotNum);
            window.__LOAD_FROM_SLOT__ = slotNum;
            window.__GAME_DIFFICULTY__ = null; // Will be loaded from save
            saveMenu.classList.remove('visible');
            window.requestGameStart && window.requestGameStart();
          }
        });
        
        // Save button click handler
        document.addEventListener('click', (e) => {
          const saveBtn = e.target.closest('.save-btn');
          if (!saveBtn) return;
          
          const saveMenu = document.getElementById('saveMenu');
          if (!saveMenu.classList.contains('visible')) return;
          if (!saveMenu.contains(saveBtn)) return;
          
          const slotEl = saveBtn.closest('.save-slot');
          if (!slotEl) return;
          
          const slotNum = parseInt(slotEl.getAttribute('data-slot'));
          const isInGame = window.game && window.game.started && !window.game.dead;
          
          if (!isInGame) {
            console.warn('[Save Menu] Cannot save - game not in progress');
            return;
          }
          
          console.log('[Save Menu] Save button clicked - Slot:', slotNum);
          
          // Save to this slot
          if (window.saveManager && window.game && window.game.player && window.GAME) {
            const saved = window.saveManager.saveToSlot(
              slotNum,
              window.game.player,
              window.game.coins || 0,
              window.game.depth || 1,
              window.GAME ? window.GAME.difficulty : 'medium',
              window.game.gameTime || 0
            );
            if (saved) {
              window.game.promptTimed(`üíæ Saved to Slot ${slotNum}!`, 1.5);
              console.log('[Save Menu] Successfully saved to slot:', slotNum);
              updateSaveSlots();
            } else {
              console.error('[Save Menu] Failed to save to slot:', slotNum);
            }
          } else {
            console.error('[Save Menu] Missing required data for saving');
          }
        });
        
        // Save button click handler
        document.addEventListener('click', (e) => {
          const saveBtn = e.target.closest('.save-btn');
          if (!saveBtn) return;
          
          const saveMenu = document.getElementById('saveMenu');
          if (!saveMenu.classList.contains('visible')) return;
          if (!saveMenu.contains(saveBtn)) return;
          
          const slotEl = saveBtn.closest('.save-slot');
          if (!slotEl) return;
          
          const slotNum = parseInt(slotEl.getAttribute('data-slot'));
          const isInGame = window.game && window.game.started && !window.game.dead;
          
          if (!isInGame) {
            console.warn('[Save Menu] Cannot save - game not in progress');
            return;
          }
          
          console.log('[Save Menu] Save button clicked - Slot:', slotNum);
          
          // Save to this slot
          if (window.saveManager && window.game && window.game.player && window.GAME) {
            const saved = window.saveManager.saveToSlot(
              slotNum,
              window.game.player,
              window.game.coins || 0,
              window.game.depth || 1,
              window.GAME ? window.GAME.difficulty : 'medium',
              window.game.gameTime || 0
            );
            if (saved) {
              window.game.promptTimed(`üíæ Saved to Slot ${slotNum}!`, 1.5);
              console.log('[Save Menu] Successfully saved to slot:', slotNum);
              updateSaveSlots();
            } else {
              console.error('[Save Menu] Failed to save to slot:', slotNum);
            }
          } else {
            console.error('[Save Menu] Missing required data for saving');
          }
        });
        
        // Delete save slot - use event delegation
        document.addEventListener('click', (e) => {
          const deleteBtn = e.target.closest('.delete-btn');
          if (!deleteBtn || deleteBtn.disabled) return;
          
          const saveMenu = document.getElementById('saveMenu');
          if (!saveMenu.classList.contains('visible')) return;
          if (!saveMenu.contains(deleteBtn)) return;
          
          const slotEl = deleteBtn.closest('.save-slot');
          if (!slotEl) return;
          
          const slotNum = parseInt(slotEl.getAttribute('data-slot'));
          
          if (confirm(`Delete save slot ${slotNum}?`)) {
            window.saveManager && window.saveManager.deleteSlot(slotNum);
            updateSaveSlots();
            console.log('[Save Menu] Deleted slot:', slotNum);
          }
        });
        
        // Initial update
        updateSaveSlots();
        
        // Load Game button - open save menu
        const loadGameBtn = document.getElementById('loadGameBtn');
        const saveMenu = document.getElementById('saveMenu');
        const closeSaveMenu = document.getElementById('closeSaveMenu');
        
        loadGameBtn?.addEventListener('click', () => {
          saveMenu.classList.add('visible');
          updateSaveMenuMode();
          updateSaveSlots(); // Refresh slot data when opening
        });
        
        closeSaveMenu?.addEventListener('click', () => {
          saveMenu.classList.remove('visible');
        });
        
        // Close menu when clicking outside
        saveMenu?.addEventListener('click', (e) => {
          if (e.target === saveMenu) {
            saveMenu.classList.remove('visible');
          }
        });
      });
      
      // Fallback: capture start intent before modules load
      window.requestGameStart = function(){
        window.__REQUEST_START__ = true;
        const ov = document.getElementById('overlay');
        ov?.classList.remove('visible');
        console.log('Fallback start intent captured (before module). Difficulty:', window.__GAME_DIFFICULTY__);
      };
      // Global error handlers
      window.addEventListener('error', function(e) {
        console.error('Global error:', e.message, e.filename, e.lineno, e.colno);
      });
      window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
      });
    </script>
    <script type="module">
      console.log('Bootloader: importing main.js ...');
      import('./js/main.js')
        .then(()=> console.log('Bootloader: main.js loaded'))
        .catch(err => {
          console.error('Failed to load main.js:', err);
          const p = document.createElement('p');
          p.textContent = 'Failed to load game scripts: ' + (err?.message || err);
          p.style.color = '#ff5252';
          p.style.marginTop = '8px';
          document.querySelector('.panel')?.appendChild(p);
        });
    </script>
    
    <!-- Save/Load Menu Overlay -->
    <div id="saveMenu" class="save-menu-overlay" data-mode="load">
      <div class="save-menu-panel">
        <h2 class="save-menu-title">üíæ Save / Load Game</h2>
        
        <div class="save-slots-container">
            <div class="save-slot" data-slot="1">
              <div class="slot-number">SLOT 1</div>
              <div class="slot-info">
                <div class="slot-empty">Empty Slot</div>
                <div class="slot-data" style="display:none;">
                  <div class="slot-level">Level: <span class="level-val">--</span> | Coins: <span class="coins-val">--</span></div>
                  <div class="slot-layer">Layer: <span class="layer-val">--</span></div>
                  <div class="slot-diff">Difficulty: <span class="diff-val">--</span></div>
                  <div class="slot-time">Saved: <span class="time-val">--</span></div>
                </div>
              </div>
            <div class="slot-buttons">
              <button class="save-btn">SAVE</button>
              <button class="load-btn" disabled>LOAD</button>
              <button class="delete-btn" disabled>DELETE</button>
            </div>
          </div>
          
            <div class="save-slot" data-slot="2">
              <div class="slot-number">SLOT 2</div>
              <div class="slot-info">
                <div class="slot-empty">Empty Slot</div>
                <div class="slot-data" style="display:none;">
                  <div class="slot-level">Level: <span class="level-val">--</span> | Coins: <span class="coins-val">--</span></div>
                  <div class="slot-layer">Layer: <span class="layer-val">--</span></div>
                  <div class="slot-diff">Difficulty: <span class="diff-val">--</span></div>
                  <div class="slot-time">Saved: <span class="time-val">--</span></div>
                </div>
              </div>
            <div class="slot-buttons">
              <button class="save-btn">SAVE</button>
              <button class="load-btn" disabled>LOAD</button>
              <button class="delete-btn" disabled>DELETE</button>
            </div>
          </div>
          
            <div class="save-slot" data-slot="3">
              <div class="slot-number">SLOT 3</div>
              <div class="slot-info">
                <div class="slot-empty">Empty Slot</div>
                <div class="slot-data" style="display:none;">
                  <div class="slot-level">Level: <span class="level-val">--</span> | Coins: <span class="coins-val">--</span></div>
                  <div class="slot-layer">Layer: <span class="layer-val">--</span></div>
                  <div class="slot-diff">Difficulty: <span class="diff-val">--</span></div>
                  <div class="slot-time">Saved: <span class="time-val">--</span></div>
                </div>
              </div>
            <div class="slot-buttons">
              <button class="save-btn">SAVE</button>
              <button class="load-btn" disabled>LOAD</button>
              <button class="delete-btn" disabled>DELETE</button>
            </div>
          </div>
        </div>
        
        <button id="closeSaveMenu" class="close-save-menu-btn">‚Üê BACK</button>
      </div>
    </div>
  </body>
  </html>
